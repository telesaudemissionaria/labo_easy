<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MISSIONARY MEDICAL CARE</title>
    <meta name="theme-color" content="#ffffff"/>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* bg-slate-50 */
        }
        .loader {
            border-top-color: #0d9488; /* teal-600 */
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .tab-btn.active {
            border-bottom-color: #0d9488; /* teal-600 */
            color: #0d9488;
            font-weight: 600;
        }
        @media print {
            body {
                background-color: white !important;
            }
            body * {
                visibility: hidden;
            }
            #report-output, #report-output * {
                visibility: visible;
            }
             .tab-buttons-container, #action-buttons-container, #main-header, #main-footer, #input-section, #whatsapp-share-btn { /* Hide the share button on print */
                display: none !important;
            }
            #report-output {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                box-shadow: none;
                border: none;
            }
            .tab-content {
                display: block !important; /* Mostra todo o conteúdo na impressão */
                margin-bottom: 2rem;
                padding: 0 !important;
            }
            h2 {
                padding-top: 1rem;
                border-top: 1px solid #ccc;
            }
        }
    </style>
</head>
<body class="bg-slate-50 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        <header id="main-header" class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">MISSIONARY MEDICAL CARE ⚕️</h1>
            <p class="text-md text-gray-600 mt-2">Uma ferramenta de apoio para o análise de exames, baseada em IA e em suas referências.</p>
        </header>

        <main>
            <!-- Sección de Inserción de Datos -->
            <div id="input-section" class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                <form id="lab-form">
                    <h2 class="text-2xl font-semibold mb-6 text-gray-900 border-b border-gray-200 pb-3">Datos del Paciente y Exámenes</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-x-8 gap-y-6">
                        
                        <!-- Columna 1: Hematología -->
                        <div class="space-y-6">
                            <div>
                                <h3 class="text-lg font-semibold mb-3 text-teal-700">Serie Roja</h3>
                                <div class="space-y-3">
                                    <div><label for="hemoglobina" class="text-sm font-medium text-gray-700">Hemoglobina (g/dL)</label><input type="text" id="hemoglobina" class="mt-1 w-full rounded-md border-gray-300 shadow-sm p-2 text-sm focus:ring-teal-500 focus:border-teal-500" placeholder="12-18"></div>
                                    <div><label for="hematocrito" class="text-sm font-medium text-gray-700">Hematocrito (%)</label><input type="text" id="hematocrito" class="mt-1 w-full rounded-md border-gray-300 shadow-sm p-2 text-sm focus:ring-teal-500 focus:border-teal-500" placeholder="36-50"></div>
                                    <div><label for="hematies" class="text-sm font-medium text-gray-700">G. Rojos (x10⁶/µL)</label><input type="text" id="hematies" class="mt-1 w-full rounded-md border-gray-300 shadow-sm p-2 text-sm focus:ring-teal-500 focus:border-teal-500" placeholder="4.0-6.0"></div>
                                    <div><label for="vcm" class="text-sm font-medium text-gray-700">VCM (fL)</label><input type="text" id="vcm" class="mt-1 w-full rounded-md border-gray-300 shadow-sm p-2 text-sm focus:ring-teal-500 focus:border-teal-500" placeholder="80-93"></div>
                                    <div><label for="hcm" class="text-sm font-medium text-gray-700">HCM (pg)</label><input type="text" id="hcm" class="mt-1 w-full rounded-md border-gray-300 shadow-sm p-2 text-sm focus:ring-teal-500 focus:border-teal-500" placeholder="27-32"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Columna 2: Serie Blanca & Coagulación -->
                        <div class="space-y-6">
                            <div>
                                <h3 class="text-lg font-semibold mb-3 text-teal-700">Serie Blanca</h3>
                                 <div class="space-y-3">
                                    <div><label for="leucocitos" class="text-sm font-medium text-gray-700">Leucocitos (/mm³)</label><input type="text" id="leucocitos" class="mt-1 w-full rounded-md border-gray-300 shadow-sm p-2 text-sm focus:ring-teal-500 focus:border-teal-500" placeholder="4.000-11.000"></div>
                                    <div><label for="neutrofilos" class="text-sm font-medium text-gray-700">Neutrófilos (%)</label><input type="text" id="neutrofilos" class="mt-1 w-full rounded-md border-gray-300 shadow-sm p-2 text-sm focus:ring-teal-500 focus:border-teal-500" placeholder="45-75"></div>
                                    <div><label for="linfocitos" class="text-sm font-medium text-gray-700">Linfocitos (%)</label><input type="text" id="linfocitos" class="mt-1 w-full rounded-md border-gray-300 shadow-sm p-2 text-sm focus:ring-teal-500 focus:border-teal-500" placeholder="25-40"></div>
                                    <div><label for="monocitos" class="text-sm font-medium text-gray-700">Monocitos (%)</label><input type="text" id="monocitos" class="mt-1 w-full rounded-md border-gray-300 shadow-sm p-2 text-sm focus:ring-teal-500 focus:border-teal-500" placeholder="4-10"></div>
                                    <div><label for="eosinofilos" class="text-sm font-medium text-gray-700">Eosinófilos (%)</label><input type="text" id="eosinofilos" class="mt-1 w-full rounded-md border-gray-300 shadow-sm p-2 text-sm focus:ring-teal-500 focus:border-teal-500" placeholder="0-5"></div>
                                    <div><label for="cayados" class="text-sm font-medium text-gray-700">Cayados (%)</label><input type="text" id="cayados" class="mt-1 w-full rounded-md border-gray-300 shadow-sm p-2 text-sm focus:ring-teal-500 focus:border-teal-500" placeholder="0-4"></div>
                                 </div>
                            </div>
                        </div>
                        
                        <!-- Columna 3: Química -->
                        <div class="space-y-6">
                            <div>
                                <h3 class="text-lg font-semibold mb-3 text-teal-700">Química y Coagulación</h3>
                                <div class="space-y-3">
                                    <div><label for="glicose" class="text-sm font-medium text-gray-700">Glucemia (mg/dL)</label><input type="text" id="glicose" class="mt-1 w-full rounded-md border-gray-300 shadow-sm p-2 text-sm focus:ring-teal-500 focus:border-teal-500" placeholder="70-125"></div>
                                    <div><label for="creatinina" class="text-sm font-medium text-gray-700">Creatinina (mg/dL)</label><input type="text" id="creatinina" class="mt-1 w-full rounded-md border-gray-300 shadow-sm p-2 text-sm focus:ring-teal-500 focus:border-teal-500" placeholder="0.6-1.4"></div>
                                    <div><label for="ast_tgo" class="text-sm font-medium text-gray-700">AST/TGO (U/L)</label><input type="text" id="ast_tgo" class="mt-1 w-full rounded-md border-gray-300 shadow-sm p-2 text-sm focus:ring-teal-500 focus:border-teal-500" placeholder="10-40"></div>
                                    <div><label for="alt_tgp" class="text-sm font-medium text-gray-700">ALT/TGP (U/L)</label><input type="text" id="alt_tgp" class="mt-1 w-full rounded-md border-gray-300 shadow-sm p-2 text-sm focus:ring-teal-500 focus:border-teal-500" placeholder="10-40"></div>
                                    <div><label for="plaquetas" class="text-sm font-medium text-gray-700">Plaquetas (/mm³)</label><input type="text" id="plaquetas" class="mt-1 w-full rounded-md border-gray-300 shadow-sm p-2 text-sm focus:ring-teal-500 focus:border-teal-500" placeholder="150k-400k"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Columna 4: Enfermedades Regionales -->
                        <div class="space-y-6">
                            <div>
                                <h3 class="text-lg font-semibold mb-3 text-teal-700">Enf. Regionales (Bolivia)</h3>
                                <div class="bg-slate-50 p-4 rounded-lg space-y-4 border border-slate-200">
                                    <div>
                                        <h4 class="font-semibold text-gray-800">Chagas</h4>
                                        <div class="space-y-3 mt-2">
                                            <div><label for="chagas_micrometodo" class="text-sm font-medium text-gray-700">Micrométodo (RN)</label><input type="text" id="chagas_micrometodo" class="mt-1 w-full rounded-md border-gray-300 shadow-sm p-2 text-sm focus:ring-teal-500 focus:border-teal-500" placeholder="Positivo/Negativo"></div>
                                            <div><label for="chagas_serologia_materna" class="text-sm font-medium text-gray-700">Serología Materna</label><input type="text" id="chagas_serologia_materna" class="mt-1 w-full rounded-md border-gray-300 shadow-sm p-2 text-sm focus:ring-teal-500 focus:border-teal-500" placeholder="Reactivo/No Reactivo"></div>
                                            <div><label for="chagas_serologia_nino" class="text-sm font-medium text-gray-700">Serología Niño >6m</label><input type="text" id="chagas_serologia_nino" class="mt-1 w-full rounded-md border-gray-300 shadow-sm p-2 text-sm focus:ring-teal-500 focus:border-teal-500" placeholder="Título 1/128"></div>
                                        </div>
                                    </div>
                                    <div>
                                        <h4 class="font-semibold text-gray-800">Dengue</h4>
                                        <div class="space-y-3 mt-2">
                                             <div><label for="dengue_pcr_ns1" class="text-sm font-medium text-gray-700">Antígeno NS1 / PCR</label><input type="text" id="dengue_pcr_ns1" class="mt-1 w-full rounded-md border-gray-300 shadow-sm p-2 text-sm focus:ring-teal-500 focus:border-teal-500" placeholder="Positivo/Negativo"></div>
                                             <div><label for="dengue_serologia_igm" class="text-sm font-medium text-gray-700">Serología IgM</label><input type="text" id="dengue_serologia_igm" class="mt-1 w-full rounded-md border-gray-300 shadow-sm p-2 text-sm focus:ring-teal-500 focus:border-teal-500" placeholder="Reactivo/No Reactivo"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-6">
                            <label for="outros_dados" class="block text-sm font-medium text-gray-700">Otros datos relevantes (signos, síntomas, comorbilidades)</label>
                           <textarea id="outros_dados" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 focus:ring-teal-500 focus:border-teal-500" placeholder="Ej: Paciente de 45 años, masculino, con fiebre hace 3 días y tos productiva. Residente de zona endémica para Chagas."></textarea>
                    </div>
                    
                    <div id="action-buttons-container" class="mt-8 pt-6 border-t border-gray-200 flex flex-col md:flex-row justify-center items-center gap-4">
                        <button type="button" id="generate-report-btn" class="w-full md:w-auto bg-teal-600 hover:bg-teal-700 text-white font-bold py-2.5 px-6 rounded-lg shadow-md transition-all duration-300 focus:outline-none focus:ring-4 focus:ring-teal-300">
                            Generar Reporte
                        </button>
                        <button type="button" id="print-report-btn" class="w-full md:w-auto bg-slate-600 hover:bg-slate-700 text-white font-bold py-2.5 px-6 rounded-lg shadow-md transition-all duration-300 focus:outline-none focus:ring-4 focus:ring-slate-300" style="display: none;">
                            Imprimir Reporte
                        </button>
                        <button type="button" id="whatsapp-share-btn" class="w-full md:w-auto bg-green-500 hover:bg-green-600 text-white font-bold py-2.5 px-6 rounded-lg shadow-md transition-all duration-300 focus:outline-none focus:ring-4 focus:ring-green-300" style="display: none;">
                            Compartir no WhatsApp
                        </button>
                           <button type="button" id="install-app-btn" class="w-full md:w-auto bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2.5 px-6 rounded-lg shadow-md transition-all duration-300 focus:outline-none focus:ring-4 focus:ring-indigo-300" style="display: none;">
                            Instalar App
                        </button>
                        <button type="button" id="clear-form-btn" class="w-full md:w-auto bg-white hover:bg-gray-100 text-gray-700 font-bold py-2.5 px-6 rounded-lg shadow-md border border-gray-300 transition-all duration-300 focus:outline-none focus:ring-4 focus:ring-gray-200">
                            Limpiar Formulario
                        </button>
                    </div>
                </form>
            </div>

            <div id="loading-section" class="text-center my-10" style="display: none;">
                <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-24 w-24 mx-auto"></div>
                <p class="mt-4 text-lg text-gray-600">Analizando datos... Por favor, espere.</p>
            </div>
            
            <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative my-6" role="alert">
                <strong class="font-bold">¡Ocurrió un error!</strong>
                <span id="error-content" class="block sm:inline">No fue posible generar el reporte. Por favor, intente nuevamente.</span>
            </div>

            <!-- Seção do Relatório Gerado -->
            <div id="report-output" style="display: none;" class="mt-10 bg-white p-6 rounded-lg shadow-md border border-gray-200">
                <!-- Abas de Navegação -->
                <div class="tab-buttons-container border-b border-gray-200 mb-4">
                    <nav class="tab-buttons -mb-px flex space-x-6" aria-label="Tabs">
                        <button class="tab-btn active whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm" data-tab="tabla-resumen-section">Tabla Resumen</button>
                        <button class="tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="explicacion-sencilla-section">Para el Paciente</button>
                        <button class="tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="reporte-detallado-section">Reporte Detallado</button>
                        <button class="tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="explicacion-tecnica-section">Glosario Técnico</button>
                        <button class="tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="referencias-section">Referencias</button>
                    </nav>
                </div>
                
                <!-- Conteúdo das Abas -->
                <div id="tabla-resumen-section" class="tab-content active">
                    <h2 class="text-xl font-bold text-gray-900 mb-4">Tabla Resumen</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full">
                            <thead class="bg-teal-600">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Parámetro</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Valor</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Referencia</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Interpretación</th>
                                </tr>
                            </thead>
                            <tbody id="summary-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
                
                 <div id="explicacion-sencilla-section" class="tab-content">
                    <h2 class="text-xl font-bold text-gray-900 mb-4">Para el Paciente: ¿Qué significan sus exámenes?</h2>
                    <div id="explicacion-sencilla-content" class="prose max-w-none text-gray-700"></div>
                </div>

                <div id="reporte-detallado-section" class="tab-content">
                    <h2 class="text-xl font-bold text-gray-900 mb-4">Reporte Detallado (Técnico)</h2>
                    <div id="reporte-detallado-content" class="space-y-4 prose max-w-none text-gray-700"></div>
                </div>

                <div id="explicacion-tecnica-section" class="tab-content">
                    <h2 class="text-xl font-bold text-gray-900 mb-4">Glosario y Explicación Técnica</h2>
                    <div id="explicacion-tecnica-content" class="prose max-w-none text-gray-700"></div>
                </div>
                
                <div id="referencias-section" class="tab-content">
                    <h2 class="text-xl font-bold text-gray-900 mb-4">Referencias</h2>
                    <div id="referencias-content" class="prose max-w-none text-sm text-gray-600"></div>
                </div>
            </div>
        </main>

        <footer id="main-footer" class="text-center mt-12 text-sm text-gray-500">
            <p>Desarrollado como una herramienta de apoyo para profesionales en missão.</p>
            <p>&copy; 2024. Todos los derechos reservados.</p>
            <p class="mt-4 text-xs text-red-700">
                As informações neste aplicativo não têm a intenção de ser aconselhamento profissional nem têm a intenção de substituir uma consulta pessoal com um médico, farmacêutico ou outro profissional de saúde qualificado. O leitor não deve desconsiderar aconselhamento médico nem adiar a busca por aconselhamento médico devido a alguma informação encontrada neste aplicativo.
            </p>
        </footer>
    </div>

    <script type="module">
        // --- Registro do Service Worker para PWA ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').then(registration => {
                    console.log('ServiceWorker registrado com sucesso: ', registration.scope);
                }).catch(error => {
                    console.log('Falha no registro do ServiceWorker: ', error);
                });
            });
        }
        
        // --- Lógica para o botão de instalação ---
        const installBtn = document.getElementById('install-app-btn');
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installBtn.style.display = 'block';
        });
        installBtn.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                deferredPrompt = null;
                installBtn.style.display = 'none';
            }
        });

        // --- Lógica principal da aplicação ---
        const generateBtn = document.getElementById('generate-report-btn');
        const printBtn = document.getElementById('print-report-btn');
        const whatsappShareBtn = document.getElementById('whatsapp-share-btn'); // Get the new WhatsApp button
        const clearBtn = document.getElementById('clear-form-btn');
        const labForm = document.getElementById('lab-form');
        
        const loadingSection = document.getElementById('loading-section');
        const errorMessage = document.getElementById('error-message');
        const reportOutput = document.getElementById('report-output');

        const showSection = (section, show) => {
            if (section) section.style.display = show ? 'block' : 'none';
        };

        generateBtn.addEventListener('click', async () => {
            showSection(errorMessage, false);
            showSection(reportOutput, false);
            showSection(loadingSection, true);
            showSection(printBtn, false);
            showSection(whatsappShareBtn, false); // Hide WhatsApp share button initially
            
            const labData = {
                hemoglobina: document.getElementById('hemoglobina').value,
                hematocrito: document.getElementById('hematocrito').value,
                leucocitos: document.getElementById('leucocitos').value,
                plaquetas: document.getElementById('plaquetas').value,
                glicose: document.getElementById('glicose').value,
                creatinina: document.getElementById('creatinina').value,
                ast_tgo: document.getElementById('ast_tgo').value,
                alt_tgp: document.getElementById('alt_tgp').value,
                chagas_micrometodo: document.getElementById('chagas_micrometodo').value,
                chagas_serologia_materna: document.getElementById('chagas_serologia_materna').value,
                chagas_serologia_nino: document.getElementById('chagas_serologia_nino').value,
                dengue_pcr_ns1: document.getElementById('dengue_pcr_ns1').value,
                dengue_serologia_igm: document.getElementById('dengue_serologia_igm').value,
                outros_dados: document.getElementById('outros_dados').value,
            };

            const dataString = Object.entries(labData)
                .filter(([_, value]) => value && value.trim() !== '')
                .map(([key, value]) => `- ${key.replace(/_/g, ' ')}: ${value}`)
                .join('\n');
            
            const referenceText = `
                ### HEMATOLOGÍA GENERAL
                - HEMOGLOBINA (Hb) 12-18 g/dl: > Leucocitosis, hiperlipidemia, fumadores, hemoconcentración, policitemia. | < ANEMIA: Déficit de hierro, aplasia medular, déficit de B12, hemólisis, hemorragias.
                - HEMATOCRITO (Ht) 36-50%: > Hemoconcentración, policitemia. | < ANEMIA, hemodilución.
                - LEUCOCITOS 4k-11k/mm³: > Leucocitosis: Infección, inflamación, leucemias. | < Leucopenia: Dengue, quimio, sepsis, autoinmune.
                - PLAQUETAS 150k-400k/mm³: > Trombocitosis: Reactiva a infección/inflamación, neoplasia. | < Trombocitopenia: Dengue, PTI, Lupus, fármacos, hiperesplenismo.
                ### BIOQUÍMICA GENERAL
                - CREATININA 0.6-1.4 mg/dl: > Insuficiencia Renal, < TFG.
                - TGO/AST 10-40 U/L: > Daño hepático, pancreatitis aguda, IAM, cirrosis, alcoholismo, rabdomiólisis.
                - TGP/ALT 10-40 U/L: > Hepatitis (aguda, viral), autoinmune, fármacos. Es más específica del hígado.
                ### ANÁLISIS ESPECÍFICO PARA BOLIVIA
                #### CHAGAS
                - Diagnóstico en RN (0-6 meses): MICROMÉTODO. Positivo confirma Chagas Congénito.
                - Diagnóstico en Niño >6m: SEROLOGÍA (HAI/ELISA). Positivo confirma Chagas Congénito.
                - Serología Materna Reactiva: Indica que la madre tiene Chagas.
                #### DENGUE
                - Signos de Alarma: Dolor abdominal, vómitos persistentes, sangrado de mucosas, aumento del hematocrito con caída de plaquetas.
                - Diagnóstico Agudo (1-5 días): Antígeno NS1 o RT-PCR.
                - Diagnóstico Convaleciente (>5 días): Serología IgM.
            `;
            
            const promptText = `
                Actúa como un médico especialista en patología clínica. Analiza los siguientes resultados de laboratorio y datos clínicos.
                Usa tu conocimiento y, FUNDAMENTALMENTE, la base de referencia que te proporciono para guiar tu interpretación. El reporte debe ser en español.
                ## Datos del Paciente:
                ${dataString}
                ## Base de Conocimiento de Referencia:
                ${referenceText}
                La respuesta DEBE seguir el formato JSON del schema. Sé completo y basa tus "causas posibles" en la referencia.`;
            
            const schema = {
                type: "OBJECT",
                properties: {
                    tablaResumen: { type: "ARRAY", items: { type: "OBJECT", properties: { parametro: { type: "STRING" }, valor: { type: "STRING" }, referencia: { type: "STRING" }, interpretacion: { type: "STRING" } }, required: ["parametro", "valor", "referencia", "interpretacion"] } },
                    explicacionSencilla: { type: "STRING" },
                    reporteDetallado: { type: "OBJECT", properties: { interpretacion: { type: "STRING" }, conductas: { type: "STRING" }, alertas: { type: "STRING" }, hipotesis: { type: "STRING" }, diagnosticosDiferenciales: { type: "STRING" }, causas: { type: "STRING" } }, required: ["interpretacion", "conductas", "alertas", "hipotesis", "diagnosticosDiferenciales", "causas"] },
                    explicacionTecnica: { type: "STRING" },
                    referencias: { type: "STRING" }
                },
                required: ["tablaResumen", "explicacionSencilla", "reporteDetallado", "explicacionTecnica", "referencias"]
            };

            try {
                const apiKey = ""; // Keep this empty, Canvas will provide it at runtime
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                const payload = { contents: [{ role: "user", parts: [{ text: promptText }] }], generationConfig: { responseMimeType: "application/json", responseSchema: schema } };
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) {
                    let errorMsg = `Error de API: ${response.status}.`;
                    try {
                        const errorBody = await response.json();
                        errorMsg = errorBody.error?.message || JSON.stringify(errorBody);
                    } catch (e) { errorMsg += ' No se pudo obtener más detalles del error.'; }
                    throw new Error(errorMsg);
                }
                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts) {
                    const reportData = JSON.parse(result.candidates[0].content.parts[0].text);
                    displayReport(reportData);
                } else {
                    throw new Error("La respuesta de la API fue inválida o vacía.");
                }
            } catch (error) {
                console.error("Error al generar reporte:", error);
                document.getElementById('error-content').textContent = error.message;
                showSection(errorMessage, true);
            } finally {
                showSection(loadingSection, false);
            }
        });

        clearBtn.addEventListener('click', () => {
            labForm.reset();
            showSection(reportOutput, false);
            showSection(printBtn, false);
            showSection(whatsappShareBtn, false); // Hide WhatsApp share button on clear
            window.scrollTo(0, 0);
        });
        
        printBtn.addEventListener('click', () => { window.print(); });

        // WhatsApp share functionality
        whatsappShareBtn.addEventListener('click', () => {
            const reportContent = document.getElementById('reporte-detallado-content').innerText;
            const message = encodeURIComponent(`Aquí está un resumen de su reporte de laboratorio:\n\n${reportContent}\n\nGenerado por MISSIONARY MEDICAL CARE.`);
            const whatsappUrl = `https://wa.me/?text=${message}`;
            window.open(whatsappUrl, '_blank');
        });


        // Lógica de las Abas (Tabs)
        const tabs = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const targetId = tab.dataset.tab;
                const target = document.getElementById(targetId);

                tabs.forEach(t => {
                    t.classList.remove('active', 'text-teal-600', 'border-teal-600');
                    t.classList.add('text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300', 'border-transparent');
                });
                tab.classList.add('active', 'text-teal-600', 'border-teal-600');
                tab.classList.remove('text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300', 'border-transparent');
                
                tabContents.forEach(c => c.classList.remove('active'));
                target.classList.add('active');
            });
        });

        function displayReport(data) {
            const tableBody = document.getElementById('summary-table-body');
            tableBody.innerHTML = '';
            if (data.tablaResumen) {
                data.tablaResumen.forEach((item, index) => {
                    const bgColor = index % 2 === 0 ? 'bg-white' : 'bg-slate-50';
                    let valueClass = 'text-gray-900';
                    const interp = item.interpretacion.toLowerCase();
                    if (interp.includes('alto') || interp.includes('aumentado') || interp.includes('elevado') || interp.includes('positiv') || interp.includes('reactivo') || interp.includes('>')) {
                        valueClass = 'text-red-600 font-semibold';
                    } else if (interp.includes('bajo') || interp.includes('disminuido') || interp.includes('<')) {
                        valueClass = 'text-blue-600 font-semibold';
                    }
                    const row = `<tr class="${bgColor}">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.parametro}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm ${valueClass}">${item.valor}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.referencia}</td>
                        <td class="px-6 py-4 text-sm text-gray-700">${item.interpretacion}</td>
                    </tr>`;
                    tableBody.innerHTML += row;
                });
            }

            document.getElementById('explicacion-sencilla-content').innerHTML = `<p>${(data.explicacionSencilla || '').replace(/\n/g, '</p><p>')}</p>`;
            const reporteDetallado = data.reporteDetallado || {};
            document.getElementById('reporte-detallado-content').innerHTML = `
                <h3 class="text-lg font-semibold text-gray-800">Interpretación Integrada:</h3><p>${(reporteDetallado.interpretacion || '').replace(/\n/g, '<br>')}</p>
                <h3 class="text-lg font-semibold text-gray-800">Sugerencias de Conducta:</h3><p>${(reporteDetallado.conductas || '').replace(/\n/g, '<br>')}</p>
                <h3 class="text-lg font-semibold text-gray-800">Señales de Alerta:</h3><p>${(reporteDetallado.alertas || '').replace(/\n/g, '<br>')}</p>
                <h3 class="text-lg font-semibold text-gray-800">Hipótesis Diagnósticas:</h3><p>${(reporteDetallado.hipotesis || '').replace(/\n/g, '<br>')}</p>
                <h3 class="text-lg font-semibold text-gray-800">Diagnósticos Diferenciales:</h3><p>${(reporteDetallado.diagnosticosDiferenciales || '').replace(/\n/g, '<br>')}</p>
                <h3 class="text-lg font-semibold text-gray-800">Causas Posibles (según referencia):</h3><p>${(reporteDetallado.causas || '').replace(/\n/g, '<br>')}</p>`;
            document.getElementById('explicacion-tecnica-content').innerHTML = `<p>${(data.explicacionTecnica || '').replace(/\n/g, '</p><p>')}</p`;
            document.getElementById('referencias-content').innerHTML = `<p>${(data.referencias || '').replace(/\n/g, '<br>')}</p>`;

            // Reset tabs to the first one
            document.querySelectorAll('.tab-btn').forEach((btn, index) => {
                btn.classList.toggle('active', index === 0);
                btn.classList.toggle('text-teal-600', index === 0);
                btn.classList.toggle('border-teal-600', index === 0);
                btn.classList.toggle('text-gray-500', index !== 0);
                btn.classList.toggle('border-transparent', index !== 0);
            });
            document.querySelectorAll('.tab-content').forEach((content, index) => {
                content.classList.toggle('active', index === 0);
            });

            showSection(reportOutput, true);
            showSection(printBtn, true);
            showSection(whatsappShareBtn, true); // Show WhatsApp share button after report generation
            document.getElementById('report-output').scrollIntoView({ behavior: 'smooth' });
        }
    </script>
</body>
</html>
